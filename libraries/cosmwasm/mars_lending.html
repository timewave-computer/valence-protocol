<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mars Lending - Valence Protocol Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Valence Protocol Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/timewave-computer/valence-protocol" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="valence-mars-lending-library"><a class="header" href="#valence-mars-lending-library">Valence Mars Lending library</a></h1>
<p>The Valence Mars Lending library facilitates lending operations on the <a href="https://marsprotocol.io/">Mars Protocol</a> from an input account and manages withdrawal of lent assets to an output account. The library creates and manages a Mars credit account that is owned by the input account, enabling simple lending and withdrawal operations. This library enables Valence Programs to earn yield on deposited assets through Mars Protocol's lending markets while maintaining full control over the lending positions through Mars credit accounts.</p>
<h2 id="high-level-flow"><a class="header" href="#high-level-flow">High-level Flow</a></h2>
<pre class="mermaid">---
title: Mars Lending Library
---
graph LR
  IA((Input
      Account))
  OA((Output
      Account))
  P[Processor]
  S[Mars Lending
      Library]
  MC[Mars Credit
     Manager]
  CA[Mars Credit
     Account]
  P -- 1/Lend or Withdraw --&gt; S
  S -- 2/Query balances --&gt; IA
  S -- 3/Execute Create Credit Account
  (if needed) --&gt; IA
  IA -- 4/Create Credit Account --&gt; MC
  MC -.-&gt; |4'/Create| CA
  S -- 5/Execute Lending --&gt; IA
  IA -- 6/Deposit &amp; Lend --&gt; CA
  S -- 7/Execute Withdrawal --&gt; IA
  IA -- 8/Reclaim &amp; Withdraw --&gt; CA
  IA -- 9/Transfer Tokens --&gt; OA
</pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Function</th><th>Parameters</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>Lend</strong></td><td>-</td><td>Creates a Mars credit account (if one doesn't exist) and lends the entire balance of the specified denom from the input account to the Mars Protocol through the credit account.</td></tr>
<tr><td><strong>Withdraw</strong></td><td><code>amount: Option&lt;Uint128&gt;</code></td><td>Withdraws lent assets from the Mars credit account to the output account. If no amount is specified, withdraws the entire position.</td></tr>
<tr><td><strong>Borrow</strong></td><td><code>coin: Coin</code></td><td>Borrows the specified amount of the given denom from Mars Protocol through the credit account. The borrowed tokens are sent to the output account specified in the library configuration.</td></tr>
<tr><td><strong>Repay</strong></td><td><code>coin: Coin</code></td><td>Repays borrowed assets to Mars Protocol through the input account. The <code>Coin</code> parameter contains <code>denom</code> and <code>amount</code> fields.</td></tr>
</tbody></table>
</div>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>The library is configured on instantiation via the <code>LibraryConfig</code> type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct LibraryConfig {
    // Address of the input account that will own the credit account
    pub input_addr: LibraryAccountType,
    /// Address of the output account that will receive withdrawn funds
    pub output_addr: LibraryAccountType,
    // Address of the Mars credit manager contract
    pub credit_manager_addr: String,
    // Denom of the asset we are going to lend
    pub denom: String,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="implementation-details"><a class="header" href="#implementation-details">Implementation Details</a></h2>
<h3 id="credit-account-management"><a class="header" href="#credit-account-management">Credit Account Management</a></h3>
<p>The library automatically handles Mars credit account lifecycle:</p>
<ul>
<li><strong>Account Creation</strong>: When lending is first initiated, the library checks if a credit account exists for the input address. If not, it creates one through the Mars Credit Manager.</li>
<li><strong>Account Ownership</strong>: The credit account is owned by the input account, ensuring proper access control and security.</li>
<li><strong>Single Account</strong>: Each input account maintains exactly one credit account through this library.</li>
</ul>
<h3 id="lending-process"><a class="header" href="#lending-process">Lending Process</a></h3>
<ol>
<li><strong>Balance Check</strong>: Queries the input account balance for the specified denom</li>
<li><strong>Credit Account Resolution</strong>: Either uses existing credit account or creates a new one</li>
<li><strong>Deposit &amp; Lend</strong>: Deposits the tokens into the credit account and immediately lends them to Mars Protocol</li>
<li><strong>Reply Handling</strong>: Uses CosmWasm reply mechanism to handle the two-step process of account creation followed by lending</li>
</ol>
<h3 id="withdrawal-process"><a class="header" href="#withdrawal-process">Withdrawal Process</a></h3>
<ol>
<li><strong>Credit Account Query</strong>: Retrieves the existing credit account for the input address</li>
<li><strong>Amount Calculation</strong>: Uses exact amount if specified, otherwise withdraws the entire balance</li>
<li><strong>Reclaim &amp; Withdraw</strong>: Executes two Mars actions:
<ul>
<li><code>Reclaim</code>: Withdraws the lent position back to the credit account</li>
<li><code>WithdrawToWallet</code>: Transfers the tokens from credit account to the output account</li>
</ul>
</li>
</ol>
<h3 id="borrowing-process"><a class="header" href="#borrowing-process">Borrowing Process</a></h3>
<ol>
<li><strong>Credit Account Check</strong>: Verifies the existence of a credit account for the input address</li>
<li><strong>Borrow Execution</strong>: Executes the borrow action through the Mars credit account, which:
<ul>
<li>Borrows the specified amount of the given denom</li>
<li>Transfers the borrowed tokens to the output account specified in the library configuration</li>
</ul>
</li>
</ol>
<h3 id="repayment-process"><a class="header" href="#repayment-process">Repayment Process</a></h3>
<ol>
<li><strong>Token Transfer</strong>: Transfers the repayment tokens from the input account back to the credit account</li>
</ol>
<h3 id="error-handling"><a class="header" href="#error-handling">Error Handling</a></h3>
<ul>
<li><strong>No Funds</strong>: Returns error if attempting to lend with zero balance</li>
<li><strong>No Credit Account</strong>: Returns error if attempting to withdraw without an existing credit account</li>
<li><strong>Mars Integration</strong>: Propagates Mars Protocol errors for lending/withdrawal operations</li>
</ul>
<h2 id="mars-protocol-integration"><a class="header" href="#mars-protocol-integration">Mars Protocol Integration</a></h2>
<p>This library integrates with Mars Protocol's credit account system, which provides:</p>
<ul>
<li><strong>Isolated Lending</strong>: Each credit account operates independently</li>
<li><strong>Flexible Actions</strong>: Support for multiple DeFi actions through a single account</li>
<li><strong>Risk Management</strong>: Mars Protocol's built-in risk management and liquidation mechanisms</li>
<li><strong>Composability</strong>: Credit accounts can be used for complex DeFi strategies beyond simple lending</li>
</ul>
<h2 id="thanks"><a class="header" href="#thanks">Thanks</a></h2>
<p>Thank you to Stana and the <a href="https://hydro.cosmos.network/">Hydro</a> team for contributing this library upstream.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../libraries/cosmwasm/ica_ibc_transfer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../libraries/cosmwasm/maxbtc_issuer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../libraries/cosmwasm/ica_ibc_transfer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../libraries/cosmwasm/maxbtc_issuer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>
